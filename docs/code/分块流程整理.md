# 智能摘要生成三步协同机制详解

这三个prompt通过一个**精心设计的链式工作流程**协同工作，最终生成语义连贯、上下文相关的文档摘要。让我通过一个具体例子，一步一步分析它们是如何组合工作的。

## 📚 示例文档
假设我们有一个关于**区块链共识机制**的技术文档，名为 `consensus_mechanisms.md`，内容如下：

```
1. 共识机制概述
共识机制是区块链网络中各节点达成一致的算法。它的核心目标是确保所有节点对交易记录的一致性，防止双花攻击。共识机制的选择直接影响区块链的安全性、效率性和去中心化程度。

2. 工作量证明 (PoW)
工作量证明是比特币首创的共识机制。节点通过解决复杂数学难题来竞争记账权，这个过程被称为"挖矿"。PoW的优势是安全性高，但缺点是能源消耗巨大，交易处理速度慢。

3. 权益证明 (PoS)
权益证明根据节点持有的代币数量和持有时长来选择记账者。PoS相比PoW更加节能，交易速度更快。以太坊2.0正在从PoW转向PoS。PoS的主要挑战是可能导致富者愈富的中心化问题。

4. 委托权益证明 (DPoS)
DPoS是PoS的变体，持币者通过投票选出代表节点负责验证交易。这种机制进一步提高了交易处理速度，但牺牲了一定程度的去中心化。EOS和TRON是使用DPoS的代表。
```

假设 `chunk_size` 设为约200字符，`base_splitter` 会先将文档分成4个粗糙块（每个段落大约是一个粗糙块）。

## 🔄 三步协同工作流程

以下是三个prompt协同工作的完整流程：

```mermaid
flowchart TD
    Start[开始处理文档<br>《共识机制》] --> Step1
    
    subgraph Step1 [初始总结阶段]
        A1[输入: 文档名 + 第一粗糙块内容] --> A2[Prompt 1: 基础总结<br>生成初始摘要A]
        A2 --> A3[输出: "介绍了共识机制的概念与重要性"]
    end

    Step1 --> Step2
    
    subgraph Step2 [递归决策阶段]
        B1{是否只剩一个粗糙块?} -->|否| B2[取前两个粗糙块合并]
        B2 --> B3[Prompt 2: 智能分割<br>输入: 当前摘要 + 待分割文本]
        B3 --> B4[模型分析语义结构]
        B4 --> B5[决策: 确定最佳分割点]
        B5 --> B6[输出: 语义块B + 新摘要C + 剩余文本摘要D]
        B6 --> B7[更新: text=剩余文本, summary=摘要D]
        B7 --> B1
    end
    
    B1 -->|是| Step3
    
    subgraph Step3 [精炼收尾阶段]
        C1[输入: 前文摘要 + 最后粗糙块] --> C2[Prompt 3: 总结精炼<br>生成最终摘要E]
        C2 --> C3[输出: 考虑上下文的精炼摘要]
    end

    Step3 --> Final[完成: 4个语义块<br>每个都带连贯摘要]
```

### **第一步：初始总结（Prompt 1 - `chunk_summary_template`）**

**调用时机**：在 `_get_first_chunk_summary` 方法中，处理文档的第一个粗糙块。

**输入**：
- `filename`: `"consensus_mechanisms.md"`
- `content`: 第一个粗糙块的内容（约200字符）：
  ```
  "1. 共识机制概述\n共识机制是区块链网络中各节点达成一致的算法。它的核心目标是确保所有节点对交易记录的一致性，防止双花攻击。共识机制的选择直接影响区块链的安全性、效率性和去中心化程度。"
  ```

**模型思考过程**：
1. 识别这是一个技术文档的开头部分
2. 抓住核心概念：共识机制的定义和重要性
3. 提取关键信息：节点达成一致、防止双花、影响安全性/效率/去中心化

**输出摘要**（假设）：
```
共识机制是区块链节点达成一致的算法，其核心是确保交易一致性并防止双花攻击，对区块链的安全性、效率和去中心化程度有直接影响。
```

这个摘要现在作为 `chunk_summary` 传递给下一步，成为**理解文档的起点**。

### **第二步：递归智能分割（Prompt 2 - `chunk_resplit_template`）**

这是最复杂也最关键的一步，会**多次调用**直到处理完所有粗糙块。

#### **第一次调用 `chunk_resplit_template`**

**输入**：
- `filename`: `"consensus_mechanisms.md"`
- `summary`: 第一步生成的摘要
- `content`: 前两个粗糙块合并的文本（带行号）
- `max_line_number`: 文本的行数

**模型的分析与决策**：
1. **理解上下文**：已知文档在讨论"共识机制的概念与重要性"
2. **分析结构**：发现文本从"概述"转向具体机制"工作量证明(PoW)"
3. **确定分割点**：在"概述"结束和"PoW开始"之间分割最合理
4. **生成摘要**：
   - 第一部分摘要："这部分详细阐述了共识机制的核心目标：确保节点间交易记录的一致性，防止双花攻击，并强调其对区块链三大特性（安全、效率、去中心化）的影响。"
   - 第二部分预备摘要："接下来将介绍第一种具体的共识机制——工作量证明(PoW)，包括其工作原理、优缺点。"

**输出XML**：
```xml
<result>
<chunk>
  <endline>3</endline>
  <summary>The main content of this part is detailing the core objectives of consensus mechanisms: ensuring transaction consistency among nodes, preventing double-spending attacks, and emphasizing its impact on blockchain's three key characteristics (security, efficiency, decentralization).</summary>
</chunk>
<chunk>
  <summary>The main content of this part is introducing the first specific consensus mechanism—Proof of Work (PoW), including its working principles, advantages, and disadvantages.</summary>
</chunk>
</result>
```

**更新状态**：
- 输出第一个语义块：共识机制概述部分
- 剩余文本：从"2. 工作量证明(PoW)"开始
- 新的 `chunk_summary`：第二部分的预备摘要

#### **第二次调用 `chunk_resplit_template`**

现在处理剩余文本（PoW和PoS部分）。

**模型的新一轮分析**：
1. **理解新上下文**：已知接下来要讲"工作量证明(PoW)"
2. **分析结构**：发现文本从"PoW"介绍转向"PoS"介绍
3. **确定分割点**：在PoW部分结束和PoS部分开始之间分割
4. **生成摘要**：
   - 第一部分摘要："这部分介绍了工作量证明(PoW)作为比特币首创的共识机制，其核心是通过挖矿解决数学难题来竞争记账权，具有安全性高但能耗巨大的特点。"
   - 第二部分预备摘要："接下来将讨论权益证明(PoS)机制，包括其工作原理、与PoW的比较，以及面临的中心化挑战。"

#### **第三次调用 `chunk_resplit_template`**

处理剩余文本（PoS和DPoS部分）。

**模型的分析**：
1. **理解上下文**：已知要讲"权益证明(PoS)"
2. **分析结构**：发现PoS和DPoS虽然都是PoS变体，但属于不同小节
3. **确定分割点**：将PoS和DPoS分开可能破坏连续性，因此**合并为一个语义块**
4. **生成摘要**：
   - 第一部分摘要："这部分涵盖了权益证明(PoS)及其变体委托权益证明(DPoS)，对比了它们的节能优势、性能改进，以及中心化风险。"
   - 第二部分预备摘要：无（因为只剩一个块了）

### **第三步：精炼总结（Prompt 3 - `chunk_summary_refinement_template`）**

**调用时机**：当只剩最后一个粗糙块时，在 `_get_last_chunk_summary` 中调用。

**输入**：
- `filename`: `"consensus_mechanisms.md"`
- `summary`: 上一轮生成的预备摘要（关于PoS和DPoS）
- `content`: 最后一个粗糙块内容（DPoS部分）

**模型的精炼过程**：
1. **结合上下文**：已知前面已经讨论了PoS机制
2. **理解当前内容**：这是PoS的一个变体DPoS
3. **生成连贯摘要**：不是孤立总结DPoS，而是放在整个讨论框架中

**输出摘要**：
```
作为对PoS机制的扩展，委托权益证明(DPoS)通过投票选举代表节点进一步提升了交易处理效率，但以部分去中心化为代价，EOS和TRON是该机制的代表应用。
```

## 🎯 三个Prompt的设计智慧

### **1. 角色分工明确**
| Prompt | 角色 | 输入特点 | 输出特点 |
|--------|------|----------|----------|
| **Prompt 1** | **开篇者** | 只有原始文本 | 建立初始理解框架 |
| **Prompt 2** | **决策者** | 文本 + 前文摘要 | 结构分析 + 边界决策 |
| **Prompt 3** | **收尾者** | 文本 + 完整上下文摘要 | 上下文连贯的精炼总结 |

### **2. 信息流设计**
```
原始文本 → Prompt1 → 初始摘要
                ↓
初始摘要 + 新文本 → Prompt2 → 语义块1摘要 + 预备摘要
                ↓
预备摘要 + 剩余文本 → Prompt2 → 语义块2摘要 + 新预备摘要
                ↓
                ...（递归）
                ↓
最终预备摘要 + 最后文本 → Prompt3 → 最终精炼摘要
```

### **3. 上下文传递机制**
- **显式传递**：通过 `{summary}` 参数明确传递前文摘要
- **渐进细化**：每轮摘要都比前一轮更具体、更聚焦
- **语义连贯**：确保每个块的摘要都能与前文逻辑衔接

## 💡 最终输出效果

经过这个三步流程，最终生成4个语义块，每个都有**上下文感知的摘要**：

1. **块1**（共识机制概述）
   - 摘要：`"共识机制是区块链节点达成一致的算法，其核心是确保交易一致性并防止双花攻击..."`

2. **块2**（工作量证明）
   - 摘要：`"这部分介绍了工作量证明(PoW)作为比特币首创的共识机制..."`

3. **块3**（权益证明）
   - 摘要：`"这部分涵盖了权益证明(PoS)及其变体委托权益证明(DPoS)..."`

4. **块4**（委托权益证明）
   - 摘要：`"作为对PoS机制的扩展，委托权益证明(DPoS)通过投票选举代表节点..."`

## 🎪 与传统方法的对比

| 方法 | 摘要质量 | 上下文连贯性 | 分割合理性 |
|------|----------|--------------|------------|
| **独立总结每个块** | 局部准确 | 差（块间无关联） | 依赖初始分割 |
| **本文的三步法** | 全局准确 | 优秀（继承上下文） | 动态语义调整 |

## 总结

这三个prompt通过**链式协作、上下文传递、渐进细化**的设计，实现了：

1. **从整体到局部**：先建立文档的整体理解框架，再逐步细化
2. **动态边界调整**：基于语义而非固定长度确定分割点
3. **摘要连贯性**：每个摘要都继承前文语境，形成逻辑链条
4. **递归处理**：能够适应任意长度的文档

这种设计使得最终生成的每个文档块都自带一个**既能概括本块内容，又能体现其在文档中位置的智能摘要**，极大提升了后续RAG检索的准确性和语义理解深度。